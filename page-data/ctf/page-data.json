{"componentChunkName":"component---src-templates-project-js","path":"/ctf","result":{"data":{"markdownRemark":{"frontmatter":{"title":"CTF Infrastructure on GCP","github":"","deploy":""},"html":"<h2>Introduction</h2>\n<p><code>When I became a Projects Director at the UNSW Security Society (SecSoc), one of my main responsibilities I had early on was to be in charge of setting up the infrastructure of our 2021 O-Week CTF.</code> You may think that the process of setting such infrastructure should be relatively simple. After all, if one had prior experiences in deploying web applications, this task should be trivial. The problem was that I had barely any experience in deploying a web application by myself, let alone understanding what a CTF was to begin with :P</p>\n<h2>CTF Beginnings</h2>\n<p>When being given this task, the first thing I did was to understand what a CTF was. One of my main reasons to joining SecSoc was to learn more about cyber security and develop my interest into the field. No doubt that this was perfect to do so. I have often heard the term 'Capture the Flag' before in my first year but I never understood what it means. So the first thing I did was to understand what a CTF was and to get a good practice on how it works. Luckily, as I was part of the SecSoc, there was some awesome people showing me how a CTF works :)</p>\n<h2>Timeline</h2>\n<p>So I was given about 3 weeks before deploying the CTF infrastructure for O-Week. My first week was spent in understanding what a CTF was and seeing how it was hosted. My second week was spent in understanding the platforms that was used previously within SecSoc when hosting such CTF infrastructure. My third week was spent in deploying the infrastructure itself and making sure it was ready. Looking back, the third week was the most intense but it was the most rewarding when I finally finished it :).</p>\n<h2>Prior Knowledge</h2>\n<p>When learning the ropes, it really helped me to understand what was Docker, using docker-compose, SSL certificates (HTTPS encryption), domains and setting up DNS records. Obviously there is more that you should know before setting up a CTF infrastructure but these are the main things.</p>\n<h2>Deploying the CTFd infrastructure</h2>\n<p>As described on their website, \"CTFd is a Capture The Flag (CTF) framework designed for ease of use for both administrators and users\". Naturally, all you have to do is to deploy this web application and the place to set up your CTF challenges should be set up. Huge thanks to <a href=\"https://medium.com/csictf\">csictf</a> article titled (<a href=\"https://medium.com/csictf/self-hosting-a-ctf-platform-ctfd-90f3f1611587\">\"Self-hosting a CTF Platform\"</a>) as it helped me in setting up my own infrastructure.</p>\n<h3>Creating a VM instance</h3>\n<ol>\n<li>Create a VM instance using GCP Compute Engine and pick a region to host your CTFd infrastructure (up to you, the default region, which is Iowa seems to be the cheapest. However, I recommend picking <strong>australia-southeast-1b</strong> to reduce any latency).</li>\n<li>Choose the CPU settings when creating a VM instance. I found that the <strong>e2-micro</strong> CPU is good when you want to test the infrastructure with a small number of users. Then you can scale the CPU to use the <strong>e2-medium</strong> CPU during the actual CTF.</li>\n<li>Select the default boot disk (debian) rather than using the Container Optimised OS as this allows to use any extra command line arguments (i.e. touch) if needed.</li>\n<li>Enable http and https traffic for your firewall settings.</li>\n<li>Click \"Create\". You can now ssh into the VM instance!</li>\n</ol>\n<h3>Setting up CTFd</h3>\n<ol start=\"6\">\n<li>\n<p>Once you ssh into the VM, install docker with the following commands:</p>\n<pre><code>sudo apt update\nsudo apt install --yes apt-transport-https ca-certificates curl gnupg2 software-properties-common\ncurl -fsSL https://download.docker.com/linux/debian/gpg | sudo apt-key add -\nsudo add-apt-repository \"deb [arch=amd64] https://download.docker.com/linux/debian $(lsb_release -cs) stable\"\nsudo apt update\nsudo apt install --yes docker-ce\nsudo usermod -aG docker $USER\nlogout\n</code></pre>\n<p>and ssh your way back in after <strong>logout</strong>. Now install docker-compose using these commands:</p>\n<pre><code>sudo curl -L \"https://github.com/docker/compose/releases/download/1.28.2/docker-compose-$(uname -s)-$(uname -m)\" -o /usr/local/bin/docker-compose\nsudo chmod +x /usr/local/bin/docker-compose\n</code></pre>\n</li>\n<li>\n<p>Git clone CTFd repo</p>\n<pre><code>git clone https://github.com/CTFd/CTFd.git\ncd CTFd\n</code></pre>\n<p>Optional: You can install a theme. Usually, I install this theme:</p>\n<pre><code>cd CTFd/themes\ngit clone https://github.com/abiramen/ctfd-nebula-theme.git\ncd -\n</code></pre>\n</li>\n<li>\n<p>Change up the CTFd docker-compose.yml to remove the default nginx service. The docker-compose.yml file now should look something like this</p>\n<pre><code>version: '2'\nservices:\nctfd:\nbuild: .\nuser: root\nrestart: always\nports:\n  - \"8000:8000\"\nenvironment:\n  - UPLOAD_FOLDER=/var/uploads\n  - DATABASE_URL=mysql+pymysql://ctfd:ctfd@db/ctfd\n  - REDIS_URL=redis://cache:6379\n  - WORKERS=1\n  - LOG_FOLDER=/var/log/CTFd\n  - ACCESS_LOG=-\n  - ERROR_LOG=-\n  - REVERSE_PROXY=true\nvolumes:\n  - .data/CTFd/logs:/var/log/CTFd\n  - .data/CTFd/uploads:/var/uploads\n  - .:/opt/CTFd:ro\ndepends_on:\n  - db\nnetworks:\n    default:\n    internal:\ndb:\nimage: mariadb:10.4.12\nrestart: always\nenvironment:\n  - MYSQL_ROOT_PASSWORD=ctfd\n  - MYSQL_USER=ctfd\n  - MYSQL_PASSWORD=ctfd\n  - MYSQL_DATABASE=ctfd\nvolumes:\n  - .data/mysql:/var/lib/mysql\nnetworks:\n    internal:\n# This command is required to set important mariadb defaults\ncommand: [mysqld, --character-set-server=utf8mb4, --collation-server=utf8mb4_unicode_ci, --wait_timeout=28800, --log-warnings=0]\ncache:\nimage: redis:4\nrestart: always\nvolumes:\n- .data/redis:/data\nnetworks:\n    internal:\nnetworks:\ndefault:\ninternal:\n    internal: true\n</code></pre>\n</li>\n</ol>\n<h3>Linking a domain name</h3>\n<p>We are using Cloudflare to link our domain to the CTFd external IP.</p>\n<ol start=\"9\">\n<li>Add a new DNS A record that links to the external IP address and make sure that the DNS proxy status is DNS only.</li>\n</ol>\n<h3>Using a Proxy and firewall</h3>\n<ol start=\"10\">\n<li>\n<p>Now back to the VM instance, set up a firewall and rate limiting using the commands below.</p>\n<pre><code>sudo apt update\nsudo apt install nginx ufw\nsudo ufw allow 'Nginx Full'\nsudo ufw allow 'OpenSSH'\nsudo ufw enable\n</code></pre>\n</li>\n<li>\n<p>Create a file at <strong>/etc/nginx/sites-available/mydomain.com</strong> (replace mydomain.com with your domain) with the following contents.</p>\n<pre><code>limit_req_zone  $binary_remote_addr zone=mylimit:10m rate=10r/s;\nlimit_conn_zone $binary_remote_addr zone=addr:10m;\nserver {\nserver_name mydomain.com;\nlimit_req zone=mylimit burst=15;\nlimit_conn addr 10;\nlimit_req_status 429;\nclient_max_body_size 8M;\nlocation / {\n        proxy_pass http://localhost:8000;\n    proxy_http_version 1.1;\n    proxy_set_header Upgrade $http_upgrade;\n    proxy_set_header Connection 'upgrade';\n    proxy_set_header Host $host;\n    proxy_cache_bypass $http_upgrade;\n}\n}\n</code></pre>\n<p>This sets up rate-limiting at 10 requests per second, and a max of 10 simultaneous connections per IP address at a time. Also, it tells Nginx to route requests to <strong>mydomain.com</strong> at port 8000.</p>\n</li>\n<li>\n<p>Now, create a symbolic link with these commands.</p>\n<pre><code>sudo ln -s /etc/nginx/sites-available/mydomain.com /etc/nginx/sites-enabled/mydomain.com\nsudo nginx -s reload\n</code></pre>\n</li>\n<li>Run <strong>docker-compose up -d</strong>. Now when visiting the domain, you should see CTFd running on a http connection.</li>\n</ol>\n<h3>SSLing It Up!</h3>\n<ol start=\"14\">\n<li>\n<p>To allow our domain to have HTTPS encryption, we must create an SSL certificate. Luckily, we can use Certbot and LetsEncrypt for this! Follow these commands:</p>\n<pre><code>sudo apt install certbot\nsudo certbot --nginx\n</code></pre>\n<p>From <a href=\"https://medium.com/csictf/self-hosting-a-ctf-platform-ctfd-90f3f1611587\">csictf</a>, <strong><em>this should prompt you to pick which domains you want to setup nginx for. Select the domain we setup with nginx before for CTFd, and follow the series of questions <code>certbot</code> asks. Make sure you ask Certbot to always Redirect to HTTPS, we donâ€™t want anyone accessing the website over HTTP!</em></strong></p>\n</li>\n</ol>\n<p>Now you should see that your CTFd website is fully HTTPs encrypted!</p>\n<h2>Setting up Web and Binary (Pwn) Challenges</h2>\n<p>Coming soon...</p>\n<!-- ## Links & Resources\n\n- https://github.com/abiramen/ctfd-nebula-theme\n- https://github.com/CTFd/CTFd\n- https://medium.com/csictf/self-hosting-a-ctf-platform-ctfd-90f3f1611587 -->"}},"pageContext":{"slug":"ctf"}},"staticQueryHashes":[]}