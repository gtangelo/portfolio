<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.71898f96bc1a4719a56e.css">footer{flex-direction:column;justify-content:center;height:auto;margin-top:auto;background:#fff;padding:20px 0}footer,footer>div{display:flex;align-items:center;z-index:1}footer>div{flex-direction:row;flex-wrap:wrap;justify-content:space-between;color:#000;width:150px}footer>p{color:#000;z-index:1}footer>div>a:hover{transform:scale(1.2);transition:all .2s ease-in}footer>div>a{transition:all .2s ease-out}nav{background:#fff;display:flex;justify-content:center;align-items:center;box-shadow:0 5px 24px rgba(149,157,165,.2);z-index:1;min-height:80px}.icon,nav{width:100%}.icon{position:absolute;max-width:1430px;padding:0 20px}.icon img{cursor:pointer;width:45px}.icon img,.icon img:hover{transition:transform .3s ease}.icon img:hover{transform:scale(1.06)}.menu{display:none}.menu,.nav-link{height:80px;z-index:1}.nav-link{text-decoration:none;text-transform:uppercase;font-size:18px;color:#333;display:flex;justify-content:center;align-items:center;margin:0 30px}.nav-link,.nav-link:hover{transition:color .3s ease;transition:transform .3s ease}.nav-link:hover{color:#9e9e9e;transform:scale(1.1)}@media screen and (max-width:960px){nav{flex-direction:column}.icon{display:flex;align-items:center;justify-content:space-between;position:relative}.nav-link{height:50px;width:100%;font-size:16px}.none{display:none}.menu{display:initial}}*{box-sizing:border-box;margin:0;padding:0;font-family:Montserrat,sans-serif,Segoe UI,Tahoma,Geneva,Verdana;line-height:1.6}.App{background:#fafafa;min-height:100vh;display:flex;flex-direction:column}.me{-o-object-fit:cover;object-fit:cover;border-radius:50%;height:300px;width:300px}#me-section{justify-content:space-evenly;flex-wrap:wrap}#me-section,.resume-container{display:flex;align-items:center}.resume-container{justify-content:center;max-width:900px;margin:auto;width:100%;padding:20px}.resume-container img{width:100%}.project-container{margin-top:-30vh;background-color:#fafafa}.deploy-btn,.github-btn{border-radius:20px;width:-webkit-fit-content;width:-moz-fit-content;width:fit-content;padding:5px 20px;box-shadow:0 3px 4px rgba(0,0,0,.25);transition:all .3s ease}.deploy-btn:hover,.github-btn:hover{transition:all .3s ease;transform:scale(1.1);cursor:pointer}.github-btn{background:linear-gradient(1turn,#1e2125,#2c3238)}.deploy-btn a,.github-btn a{text-decoration:none;color:#fff}.deploy-btn{background:linear-gradient(1turn,#4397d8,#71bdf7)}.btn-container{gap:15px}.btn-container,.card-labels{display:flex;justify-content:flex-start}.card-labels{padding:10px}.card-content{color:#000;padding:0 10px;height:80px}.label{border-radius:15px;padding:4px 13px;background:wheat;font-size:10px;text-transform:uppercase;font-weight:700;letter-spacing:.5px;margin-right:10px}.card-link{text-decoration:none;color:#000;transition:all .3s ease}.card-link:hover{transform:translateY(-10px);transition:all .3s ease}#hero-container{background-color:#f1f1f1}#hero-section{height:50vh}#hero-section,#projects-section{width:100%;display:flex;flex-direction:column;flex-wrap:wrap;justify-content:center}#projects-section{color:#000}.cards-section{display:flex;flex-wrap:wrap;justify-content:space-around;width:100%}</style><meta name="generator" content="Gatsby 2.26.1"/><title data-react-helmet="true">CTF Infrastructure on GCP | Gabriel Ting</title><style data-styled="" data-styled-version="5.2.1">.bHzdBa{margin:0 auto;max-width:1430px;width:100%;padding:0 20px;}/*!sc*/
data-styled.g1[id="Container-sc-16vl9q-0"]{content:"bHzdBa,"}/*!sc*/
.kUNRnR{max-width:1000px;padding-top:50px;}/*!sc*/
.kUNRnR img{width:90%;display:block;margin-left:auto;margin-right:auto;}/*!sc*/
.kUNRnR ul,.kUNRnR ol{margin-left:30px;margin-bottom:15px;}/*!sc*/
.kUNRnR li{margin-bottom:5px;}/*!sc*/
.kUNRnR h1{font-size:40px;font-weight:900;text-transform:uppercase;margin-bottom:5px;}/*!sc*/
@media (max-width:510px){.kUNRnR h1{font-size:29px;}}/*!sc*/
.kUNRnR h2{font-size:24px;border-bottom:solid #a5a5a5 1px;text-align:center;margin-top:5px;margin-bottom:15px;}/*!sc*/
.kUNRnR p > code{background-color:#faeab5;padding:5px 0;font-weight:normal;}/*!sc*/
.kUNRnR p{font-size:15px;margin-bottom:15px;}/*!sc*/
.kUNRnR pre{width:100%;color:white;overflow:auto;background:#333;padding:15px 20px;border-radius:20px;font-size:14px;margin-bottom:20px;}/*!sc*/
data-styled.g2[id="Container__ProjectContainer-sc-16vl9q-1"]{content:"kUNRnR,"}/*!sc*/
</style><link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet"/><link rel="icon" href="/favicon-32x32.png?v=245d9d7a8a02f657cc20bf9ab38144ec" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=245d9d7a8a02f657cc20bf9ab38144ec"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=245d9d7a8a02f657cc20bf9ab38144ec"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=245d9d7a8a02f657cc20bf9ab38144ec"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=245d9d7a8a02f657cc20bf9ab38144ec"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=245d9d7a8a02f657cc20bf9ab38144ec"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=245d9d7a8a02f657cc20bf9ab38144ec"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=245d9d7a8a02f657cc20bf9ab38144ec"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=245d9d7a8a02f657cc20bf9ab38144ec"/><link as="script" rel="preload" href="/webpack-runtime-5b6817f3ffd611070a2b.js"/><link as="script" rel="preload" href="/framework-81279cacaab4bdba7685.js"/><link as="script" rel="preload" href="/app-2de0c81667de83ed85d2.js"/><link as="script" rel="preload" href="/styles-7d4153d260c0197f0043.js"/><link as="script" rel="preload" href="/d7eeaac4-d7103be8872fb3087f8d.js"/><link as="script" rel="preload" href="/commons-7cc7715b2b1d753dcd5f.js"/><link as="script" rel="preload" href="/component---src-templates-project-js-6f18cee37bfef586b20d.js"/><link as="fetch" rel="preload" href="/page-data/ctf/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="App"><nav><div class="icon"><a href="/"><img src="/favicon.ico" alt="Gabriel Ting"/></a><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="menu" height="30px" width="30px" xmlns="http://www.w3.org/2000/svg"><path d="M904 160H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0 624H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0-312H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8z"></path></svg></div><a class="nav-link none" href="/about">About</a><a class="nav-link none" href="/project">Projects</a><a class="nav-link none" href="/blog">Blog</a><a class="nav-link none" href="/resume">Resume</a></nav><div class="Container-sc-16vl9q-0 Container__ProjectContainer-sc-16vl9q-1 bHzdBa kUNRnR"><h1>CTF Infrastructure on GCP</h1><div class="btn-container"></div><div><h2>Introduction</h2>
<p><code>When I became a Projects Director at the UNSW Security Society (SecSoc), one of my main responsibilities I had early on was to be in charge of setting up the infrastructure of our 2021 O-Week CTF.</code> You may think that the process of setting such infrastructure should be relatively simple. After all, if one had prior experiences in deploying web applications, this task should be trivial. The problem was that I had barely any experience in deploying a web application by myself, let alone understanding what a CTF was to begin with :P</p>
<h2>CTF Beginnings</h2>
<p>When being given this task, the first thing I did was to understand what a CTF was. One of my main reasons to joining SecSoc was to learn more about cyber security and develop my interest into the field. No doubt that this was perfect to do so. I have often heard the term 'Capture the Flag' before in my first year but I never understood what it means. So the first thing I did was to understand what a CTF was and to get a good practice on how it works. Luckily, as I was part of the SecSoc, there was some awesome people showing me how a CTF works :)</p>
<h2>Timeline</h2>
<p>So I was given about 3 weeks before deploying the CTF infrastructure for O-Week. My first week was spent in understanding what a CTF was and seeing how it was hosted. My second week was spent in understanding the platforms that was used previously within SecSoc when hosting such CTF infrastructure. My third week was spent in deploying the infrastructure itself and making sure it was ready. Looking back, the third week was the most intense but it was the most rewarding when I finally finished it :).</p>
<h2>Prior Knowledge</h2>
<p>When learning the ropes, it really helped me to understand what was Docker, using docker-compose, SSL certificates (HTTPS encryption), domains and setting up DNS records. Obviously there is more that you should know before setting up a CTF infrastructure but these are the main things.</p>
<h2>Deploying the CTFd infrastructure</h2>
<p>As described on their website, "CTFd is a Capture The Flag (CTF) framework designed for ease of use for both administrators and users". Naturally, all you have to do is to deploy this web application and the place to set up your CTF challenges should be set up. Huge thanks to <a href="https://medium.com/csictf">csictf</a> article titled (<a href="https://medium.com/csictf/self-hosting-a-ctf-platform-ctfd-90f3f1611587">"Self-hosting a CTF Platform"</a>) as it helped me in setting up my own infrastructure.</p>
<h3>Creating a VM instance</h3>
<ol>
<li>Create a VM instance using GCP Compute Engine and pick a region to host your CTFd infrastructure (up to you, the default region, which is Iowa seems to be the cheapest. However, I recommend picking <strong>australia-southeast-1b</strong> to reduce any latency).</li>
<li>Choose the CPU settings when creating a VM instance. I found that the <strong>e2-micro</strong> CPU is good when you want to test the infrastructure with a small number of users. Then you can scale the CPU to use the <strong>e2-medium</strong> CPU during the actual CTF.</li>
<li>Select the default boot disk (debian) rather than using the Container Optimised OS as this allows to use any extra command line arguments (i.e. touch) if needed.</li>
<li>Enable http and https traffic for your firewall settings.</li>
<li>Click "Create". You can now ssh into the VM instance!</li>
</ol>
<h3>Setting up CTFd</h3>
<ol start="6">
<li>
<p>Once you ssh into the VM, install docker with the following commands:</p>
<pre><code>sudo apt update
sudo apt install --yes apt-transport-https ca-certificates curl gnupg2 software-properties-common
curl -fsSL https://download.docker.com/linux/debian/gpg | sudo apt-key add -
sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/debian $(lsb_release -cs) stable"
sudo apt update
sudo apt install --yes docker-ce
sudo usermod -aG docker $USER
logout
</code></pre>
<p>and ssh your way back in after <strong>logout</strong>. Now install docker-compose using these commands:</p>
<pre><code>sudo curl -L "https://github.com/docker/compose/releases/download/1.28.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
</code></pre>
</li>
<li>
<p>Git clone CTFd repo</p>
<pre><code>git clone https://github.com/CTFd/CTFd.git
cd CTFd
</code></pre>
<p>Optional: You can install a theme. Usually, I install this theme:</p>
<pre><code>cd CTFd/themes
git clone https://github.com/abiramen/ctfd-nebula-theme.git
cd -
</code></pre>
</li>
<li>
<p>Change up the CTFd docker-compose.yml to remove the default nginx service. The docker-compose.yml file now should look something like this</p>
<pre><code>version: '2'
services:
ctfd:
build: .
user: root
restart: always
ports:
  - "8000:8000"
environment:
  - UPLOAD_FOLDER=/var/uploads
  - DATABASE_URL=mysql+pymysql://ctfd:ctfd@db/ctfd
  - REDIS_URL=redis://cache:6379
  - WORKERS=1
  - LOG_FOLDER=/var/log/CTFd
  - ACCESS_LOG=-
  - ERROR_LOG=-
  - REVERSE_PROXY=true
volumes:
  - .data/CTFd/logs:/var/log/CTFd
  - .data/CTFd/uploads:/var/uploads
  - .:/opt/CTFd:ro
depends_on:
  - db
networks:
    default:
    internal:
db:
image: mariadb:10.4.12
restart: always
environment:
  - MYSQL_ROOT_PASSWORD=ctfd
  - MYSQL_USER=ctfd
  - MYSQL_PASSWORD=ctfd
  - MYSQL_DATABASE=ctfd
volumes:
  - .data/mysql:/var/lib/mysql
networks:
    internal:
# This command is required to set important mariadb defaults
command: [mysqld, --character-set-server=utf8mb4, --collation-server=utf8mb4_unicode_ci, --wait_timeout=28800, --log-warnings=0]
cache:
image: redis:4
restart: always
volumes:
- .data/redis:/data
networks:
    internal:
networks:
default:
internal:
    internal: true
</code></pre>
</li>
</ol>
<h3>Linking a domain name</h3>
<p>We are using Cloudflare to link our domain to the CTFd external IP.</p>
<ol start="9">
<li>Add a new DNS A record that links to the external IP address and make sure that the DNS proxy status is DNS only.</li>
</ol>
<h3>Using a Proxy and firewall</h3>
<ol start="10">
<li>
<p>Now back to the VM instance, set up a firewall and rate limiting using the commands below.</p>
<pre><code>sudo apt update
sudo apt install nginx ufw
sudo ufw allow 'Nginx Full'
sudo ufw allow 'OpenSSH'
sudo ufw enable
</code></pre>
</li>
<li>
<p>Create a file at <strong>/etc/nginx/sites-available/mydomain.com</strong> (replace mydomain.com with your domain) with the following contents.</p>
<pre><code>limit_req_zone  $binary_remote_addr zone=mylimit:10m rate=10r/s;
limit_conn_zone $binary_remote_addr zone=addr:10m;
server {
server_name mydomain.com;
limit_req zone=mylimit burst=15;
limit_conn addr 10;
limit_req_status 429;
client_max_body_size 8M;
location / {
        proxy_pass http://localhost:8000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
}
}
</code></pre>
<p>This sets up rate-limiting at 10 requests per second, and a max of 10 simultaneous connections per IP address at a time. Also, it tells Nginx to route requests to <strong>mydomain.com</strong> at port 8000.</p>
</li>
<li>
<p>Now, create a symbolic link with these commands.</p>
<pre><code>sudo ln -s /etc/nginx/sites-available/mydomain.com /etc/nginx/sites-enabled/mydomain.com
sudo nginx -s reload
</code></pre>
</li>
<li>Run <strong>docker-compose up -d</strong>. Now when visiting the domain, you should see CTFd running on a http connection.</li>
</ol>
<h3>SSLing It Up!</h3>
<ol start="14">
<li>
<p>To allow our domain to have HTTPS encryption, we must create an SSL certificate. Luckily, we can use Certbot and LetsEncrypt for this! Follow these commands:</p>
<pre><code>sudo apt install certbot
sudo certbot --nginx
</code></pre>
<p>From <a href="https://medium.com/csictf/self-hosting-a-ctf-platform-ctfd-90f3f1611587">csictf</a>, <strong><em>this should prompt you to pick which domains you want to setup nginx for. Select the domain we setup with nginx before for CTFd, and follow the series of questions <code>certbot</code> asks. Make sure you ask Certbot to always Redirect to HTTPS, we don’t want anyone accessing the website over HTTP!</em></strong></p>
</li>
</ol>
<p>Now you should see that your CTFd website is fully HTTPs encrypted!</p>
<h2>Setting up Web and Binary (Pwn) Challenges</h2>
<p>Coming soon...</p>
<!-- ## Links & Resources

- https://github.com/abiramen/ctfd-nebula-theme
- https://github.com/CTFd/CTFd
- https://medium.com/csictf/self-hosting-a-ctf-platform-ctfd-90f3f1611587 --></div><br/></div><footer id="footer-contents"><div><a href="https://github.com/gtangelo" target="_blank"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" color="#000000" style="color:#000000" height="35px" width="35px" xmlns="http://www.w3.org/2000/svg"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a><a href="https://www.linkedin.com/in/gabriel-ting/" target="_blank"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" color="#000000" style="color:#000000" height="35px" width="35px" xmlns="http://www.w3.org/2000/svg"><path d="M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zM349.3 793.7H230.6V411.9h118.7v381.8zm-59.3-434a68.8 68.8 0 1 1 68.8-68.8c-.1 38-30.9 68.8-68.8 68.8zm503.7 434H675.1V608c0-44.3-.8-101.2-61.7-101.2-61.7 0-71.2 48.2-71.2 98v188.9H423.7V411.9h113.8v52.2h1.6c15.8-30 54.5-61.7 112.3-61.7 120.2 0 142.3 79.1 142.3 181.9v209.4z"></path></svg></a><a href="mailto:gabrielting.info@gmail.com" target="_blank"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" color="#000000" style="color:#000000" height="35px" width="35px" xmlns="http://www.w3.org/2000/svg"><path d="M928 160H96c-17.7 0-32 14.3-32 32v640c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V192c0-17.7-14.3-32-32-32zm-80.8 108.9L531.7 514.4c-7.8 6.1-18.7 6.1-26.5 0L189.6 268.9A7.2 7.2 0 0 1 194 256h648.8a7.2 7.2 0 0 1 4.4 12.9z"></path></svg></a></div><p>Made with ❤ using Gatsby</p></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/ctf";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-25b73876df0a2c080a82.js"],"app":["/app-2de0c81667de83ed85d2.js"],"component---src-pages-404-js":["/component---src-pages-404-js-c9c0caa61ee3121c63e2.js"],"component---src-pages-about-js":["/component---src-pages-about-js-397ab79977554f783efb.js"],"component---src-pages-blog-js":["/component---src-pages-blog-js-614e9302c0f20afd723e.js"],"component---src-pages-index-js":["/component---src-pages-index-js-014ce87da98934b170a7.js"],"component---src-pages-project-js":["/component---src-pages-project-js-847375976aee51e612e7.js"],"component---src-pages-resume-js":["/component---src-pages-resume-js-b381ba6730e5655fc822.js"],"component---src-templates-project-js":["/component---src-templates-project-js-6f18cee37bfef586b20d.js"]};/*]]>*/</script><script src="/polyfill-25b73876df0a2c080a82.js" nomodule=""></script><script src="/component---src-templates-project-js-6f18cee37bfef586b20d.js" async=""></script><script src="/commons-7cc7715b2b1d753dcd5f.js" async=""></script><script src="/d7eeaac4-d7103be8872fb3087f8d.js" async=""></script><script src="/styles-7d4153d260c0197f0043.js" async=""></script><script src="/app-2de0c81667de83ed85d2.js" async=""></script><script src="/framework-81279cacaab4bdba7685.js" async=""></script><script src="/webpack-runtime-5b6817f3ffd611070a2b.js" async=""></script></body></html>